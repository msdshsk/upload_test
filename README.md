# Advanced Chunk Upload System

モダンなチャンクアップロードシステム - 大容量ファイルの高速・安全なアップロードを実現

## 📋 概要

このプロジェクトは、大容量ファイルを効率的にアップロードするための高度なチャンクアップロードシステムです。ファイルを小さなチャンクに分割して並列アップロードを行い、ネットワーク障害時の自動リトライ機能も搭載しています。

## ✨ 特徴

### 🚀 高性能
- **並列チャンクアップロード**: 複数のチャンクを同時に処理
- **自動リトライ機能**: ネットワーク障害時の自動復旧
- **リアルタイムプログレス**: 詳細な進捗表示
- **キュー管理**: 効率的なアップロード順序制御

### 🔒 セキュリティ
- **入力検証**: 厳密なファイル・データ検証
- **ファイルタイプ制限**: 許可されたファイルのみアップロード
- **パストラバーサル対策**: セキュアなファイル管理
- **アクセス制御**: `.htaccess`による適切なアクセス制限

### 🎨 ユーザビリティ
- **ドラッグ&ドロップ**: 直感的なファイル選択
- **複数ファイル対応**: 一度に複数ファイルの処理
- **キャンセル機能**: 個別・一括キャンセル
- **統計表示**: アップロード状況の可視化

### 🛠️ 保守性
- **オブジェクト指向設計**: クリーンで拡張可能な構造
- **モジュール化**: 独立したコンポーネント
- **設定外部化**: 柔軟な設定管理
- **ログ機能**: 詳細なデバッグ情報

## 🔧 技術仕様

### バックエンド (PHP)
- **PHP 7.4+** 対応
- **PSR-4** オートローダー
- **カスタムPUTパーサー**: マルチパートデータ処理
- **例外処理**: 統一されたエラーハンドリング

### フロントエンド (JavaScript)
- **ES6+ モジュール**: モダンなJavaScript
- **Fetch API**: 非同期通信
- **Promise/async-await**: 効率的な非同期処理
- **レスポンシブデザイン**: モバイル対応

## 📂 ファイル構造

```
├── index.html              # メインのアップロードページ
├── upload.php              # アップロード処理API
├── view_uploads.php        # ファイル一覧・ダウンロード
├── README.md              # このファイル
├── js/                    # フロントエンドスクリプト
│   ├── UploadManager.js   # アップロード管理
│   ├── ProgressManager.js # プログレス表示
│   └── DragDropHandler.js # ドラッグ&ドロップ処理
├── src/Shsk/              # バックエンドライブラリ
│   ├── Autoloader.php     # オートローダー
│   ├── Upload/            # アップロード関連クラス
│   │   ├── ChunkUploadHandler.php  # メイン処理
│   │   ├── FileManager.php         # ファイル管理
│   │   ├── Config.php             # 設定管理
│   │   ├── Response.php           # レスポンス処理
│   │   ├── Validator.php          # 入力検証
│   │   ├── Logger.php             # ログ機能
│   │   └── Exception/
│   │       └── UploadException.php # 例外クラス
│   └── Http/Request/      # HTTP処理
│       └── PutRequestParser.php   # PUTリクエスト解析
├── uploads/               # アップロードファイル保存先
│   └── .htaccess         # アクセス制限
├── temp/                 # チャンクファイル一時保存
│   └── .htaccess         # アクセス完全禁止
└── logs/                 # ログファイル (自動生成)
    └── upload.log
```

## 🚀 セットアップ

### 1. 要件
- PHP 7.4 以上
- Apache または Nginx
- mod_rewrite 有効 (Apache の場合)

### 2. インストール
```bash
# リポジトリのクローン
git clone <repository-url>
cd upload_test

# 権限設定
chmod 755 uploads/
chmod 755 temp/
chmod 755 logs/
```

### 3. 設定
`upload.php` で設定をカスタマイズできます：

```php
$config = new Config([
    'upload_dir' => './uploads/',           // アップロードディレクトリ
    'temp_dir' => './temp/',               // テンポラリディレクトリ
    'max_chunk_size' => 1024 * 1024 * 10,  // チャンクサイズ (10MB)
    'max_file_size' => 1024 * 1024 * 100,  // 最大ファイルサイズ (100MB)
    'allowed_extensions' => [               // 許可する拡張子
        'jpg', 'jpeg', 'png', 'gif', 
        'pdf', 'doc', 'docx', 'txt', 
        'zip', 'mp4', 'avi', 'mov'
    ],
    'auto_create_dirs' => true,             // ディレクトリ自動作成
]);
```

## 📖 使用方法

### 1. 基本的な使用
1. `index.html` にアクセス
2. ファイルをドラッグ&ドロップ または クリックして選択
3. アップロード進捗を確認
4. 完了後、`view_uploads.php` でファイル一覧を確認

### 2. 複数ファイルアップロード
- 一度に最大10個のファイルを選択可能
- 並列処理により高速アップロード
- 個別の進捗表示とキャンセル機能

### 3. ファイル管理
- `view_uploads.php` でアップロードファイル一覧
- ファイルサイズ、更新日時、統計情報を表示
- 安全なダウンロード機能

## 🔌 API仕様

### GET /upload.php
UUIDを生成してアップロードセッションを開始

**レスポンス:**
```json
{
  "success": true,
  "data": {
    "uuid": "64f4b2c1a23f4.12345678"
  }
}
```

### PUT /upload.php
チャンクアップロードまたはファイル完了

**チャンクアップロード:**
```
Content-Type: multipart/form-data
uuid: セッションUUID
index: チャンクインデックス
data: チャンクデータ
```

**ファイル完了:**
```
Content-Type: multipart/form-data
uuid: セッションUUID
name: ファイル名
```

## 🔒 セキュリティ対策

### ファイル検証
- ファイルタイプ・拡張子の厳密チェック
- ファイルサイズ制限
- ファイル名の危険文字チェック

### アクセス制御
- `temp/` ディレクトリへの直接アクセス禁止
- `uploads/` ディレクトリでのPHP実行禁止
- セキュリティヘッダーの適用

### 入力検証
- UUID形式の検証
- チャンクインデックスの検証
- 全入力データのサニタイズ

## 🐛 トラブルシューティング

### よくある問題

1. **ディレクトリの権限エラー**
   ```bash
   chmod 755 uploads/ temp/ logs/
   ```

2. **大きなファイルのアップロード失敗**
   - `php.ini` の設定確認:
     ```ini
     upload_max_filesize = 100M
     post_max_size = 100M
     max_execution_time = 300
     ```

3. **ログでのデバッグ**
   ```bash
   tail -f logs/upload.log
   ```

## 🤝 開発者向け情報

### 拡張方法
1. `src/Shsk/Upload/` に新しいクラスを追加
2. `Config.php` に設定項目を追加
3. `ChunkUploadHandler.php` に新しい処理を統合

### テスト
```bash
# PHPUnit テストの実行 (将来実装予定)
vendor/bin/phpunit tests/
```

## 📝 変更履歴

### v2.0.0 (2024年12月)
- 完全リファクタリング
- オブジェクト指向設計への移行
- 並列アップロード機能
- セキュリティ強化
- モジュール化されたフロントエンド

### v1.0.0 (初期版)
- 基本的なチャンクアップロード機能

## 📜 ライセンス

このプロジェクトは MIT ライセンスの下で公開されています。

## 🙏 謝辞

このプロジェクトは、モダンなウェブ開発のベストプラクティスを実装したチャンクアップロードシステムのリファレンス実装として作成されました。

---

**注意**: プロダクション環境で使用する場合は、追加のセキュリティ対策とパフォーマンステストを実施してください。
